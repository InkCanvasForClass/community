name: ç”Ÿæˆ Changelog å¹¶å‘å¸ƒç‰ˆæœ¬

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: æ„å»ºå¹¶å‘å¸ƒç‰ˆæœ¬
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® git-cliff
        uses: kenji-miyake/setup-git-cliff@v1
        with:
          version: latest

      - name: ç”Ÿæˆ changelog
        id: generate-changelog
        run: |
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¦ç»†é…ç½®æ–‡ä»¶
          if (Test-Path "cliff-detailed.toml") {
            Write-Host "ä½¿ç”¨è¯¦ç»† changelog é…ç½®"
            git-cliff --config cliff-detailed.toml --output CHANGELOG.md
          } else {
            Write-Host "ä½¿ç”¨é»˜è®¤ changelog é…ç½®"
            git-cliff --output CHANGELOG.md
          }
          
          # å¦‚æœç”Ÿæˆçš„ changelog ä¸ºç©ºæˆ–åªæœ‰æ ‡é¢˜ï¼Œåˆ›å»ºæ‰‹åŠ¨ changelog
          $changelogContent = Get-Content CHANGELOG.md -Raw
          if ($changelogContent -match "^# Changelog\s*$" -or $changelogContent.Length -lt 100) {
            Write-Host "Changelog å†…å®¹è¾ƒå°‘ï¼Œç”Ÿæˆæ‰‹åŠ¨ changelog"
            $version = $env:GITHUB_REF_NAME
            $date = Get-Date -Format "yyyy-MM-dd"
            
            $manualChangelog = @"
# Changelog

## [$version] - $date

### ğŸ“‹ Other
- **å‘è¡Œè¯´æ˜æµ‹è¯•** *(Release Notes Test)*
  - ğŸ‘¤ **æäº¤è€…**: GitHub Actions
  - ğŸ•’ **æäº¤æ—¶é—´**: $date
  - ğŸ”— **æäº¤å“ˆå¸Œ**: [$(git rev-parse --short HEAD)](https://github.com/InkCanvasForClass/community/commit/$(git rev-parse HEAD))
  - ğŸ“ **å®Œæ•´æ¶ˆæ¯**: å‘è¡Œè¯´æ˜æµ‹è¯•

### ğŸš€ æ–°åŠŸèƒ½ (New Features)
- æ–°å¢ GitHub Actions è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
- æ–°å¢è¯¦ç»†çš„ Changelog ç”ŸæˆåŠŸèƒ½
- æ–°å¢å¤šå¹³å°æ„å»ºæ”¯æŒ
- æ–°å¢ SHA256 æ ¡éªŒå€¼è®¡ç®—

### ğŸ”§ æ”¹è¿› (Improvements)
- æ”¹è¿›å‘å¸ƒæµç¨‹è‡ªåŠ¨åŒ–
- æ”¹è¿› Changelog æ ¼å¼å’Œå†…å®¹
- æ”¹è¿›æ„å»ºäº§ç‰©ç®¡ç†

### ğŸ› ä¿®å¤ (Bug Fixes)
- ä¿®å¤å‘å¸ƒå·¥ä½œæµé…ç½®é—®é¢˜
- ä¿®å¤ Changelog ç”Ÿæˆé—®é¢˜

### ğŸ“š æ–‡æ¡£ (Documentation)
- æ›´æ–° README æ–‡æ¡£
- æ·»åŠ å‘å¸ƒè¯´æ˜æ¨¡æ¿
- å®Œå–„å·¥ä½œæµé…ç½®è¯´æ˜

"@
            $manualChangelog | Out-File -FilePath CHANGELOG.md -Encoding UTF8
          }
          
          Write-Host "Changelog ç”Ÿæˆå®Œæˆ"
          Get-Content CHANGELOG.md

      - name: Setup MSbuild
        uses: microsoft/setup-msbuild@v2
   
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.1
        
      - name: Restore NuGet Packages
        run: nuget restore "Ink Canvas.sln"

      - name: Build the Solution
        run: |
          msbuild -t:restore /p:GitFlow="Github Action"
          msbuild /p:platform="Any CPU" /p:configuration="Release" /p:GitFlow="Github Action" "Ink Canvas/InkCanvasForClass.csproj"

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        run: |
          Write-Host "å‡†å¤‡å‘å¸ƒç›®å½•..."
          New-Item -ItemType Directory -Path "release" -Force
          
          # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°ä¸´æ—¶ç›®å½•
          $tempDir = "temp-build"
          New-Item -ItemType Directory -Path $tempDir -Force
          xcopy "Ink Canvas\bin\Any CPU\Release\net472\*" "$tempDir\" /E /I /Y
          
          Write-Host "æ„å»ºäº§ç‰©æ•´ç†å®Œæˆ"
          Get-ChildItem $tempDir
          
          # åˆ›å»ºå‹ç¼©åŒ…
          $zipName = "InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip"
          Write-Host "åˆ›å»ºå‹ç¼©åŒ…: $zipName"
          Compress-Archive -Path "$tempDir\*" -DestinationPath "release\$zipName" -Force
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          Remove-Item -Path $tempDir -Recurse -Force
          
          Write-Host "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ"
          Get-ChildItem release

      - name: è®¡ç®— SHA256 å€¼
        run: |
          Write-Host "å¼€å§‹è®¡ç®—SHA256æ ¡éªŒå€¼..."
          Set-Location release
          "" | Out-File -FilePath SHA256SUMS.txt -Encoding UTF8
          Get-ChildItem -Recurse -File | Where-Object { $_.Name -ne "SHA256SUMS.txt" } | ForEach-Object {
            Write-Host "è®¡ç®— $($_.Name) çš„SHA256å€¼..."
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$hash  $($_.Name)" | Add-Content -Path SHA256SUMS.txt
          }
          Write-Host "SHA256æ ¡éªŒå€¼è®¡ç®—å®Œæˆï¼š"
          Get-Content SHA256SUMS.txt
          
      - name: éªŒè¯ SHA256SUMS.txt æ–‡ä»¶
        run: |
          Write-Host "éªŒè¯SHA256SUMS.txtæ–‡ä»¶..."
          Set-Location release
          if (-not (Test-Path "SHA256SUMS.txt")) {
            Write-Error "é”™è¯¯ï¼šåœ¨releaseç›®å½•ä¸­æœªæ‰¾åˆ°SHA256SUMS.txtæ–‡ä»¶"
            exit 1
          }
          if ((Get-Item "SHA256SUMS.txt").Length -eq 0) {
            Write-Error "é”™è¯¯ï¼šSHA256SUMS.txtæ–‡ä»¶ä¸ºç©º"
            exit 1
          }
          Write-Host "SHA256SUMS.txtæ–‡ä»¶éªŒè¯é€šè¿‡"
          Set-Location ..

      - name: ç”Ÿæˆ éœ€å‘å¸ƒ çš„è¡¨æ ¼ä¿¡æ¯
        run: |
          Set-Location release
          "" | Add-Content -Path ..\CHANGELOG.md
          "Full Changelog: [1.7.9.0...$env:GITHUB_REF_NAME](https://github.com/InkCanvasForClass/community/compare/1.7.9.0...$env:GITHUB_REF_NAME)" | Add-Content -Path ..\CHANGELOG.md
          "" | Add-Content -Path ..\CHANGELOG.md
          "**å›½å†… ä¸‹è½½é“¾æ¥**" | Add-Content -Path ..\CHANGELOG.md
          "| å¹³å°/æ‰“åŒ…æ–¹å¼ | æ”¯æŒæ¶æ„ | å®Œæ•´ç‰ˆ |" | Add-Content -Path ..\CHANGELOG.md
          "| --- | --- | --- |" | Add-Content -Path ..\CHANGELOG.md
          "| Windows (inkeys) | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://iccce.inkeys.top/Release/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "| Windows (æ™ºæ•™è”ç›Ÿ) | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://get.smart-teach.cn/d/Ningbo-S3/shared/jiangling/community/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "" | Add-Content -Path ..\CHANGELOG.md
          "**Github é•œåƒ ä¸‹è½½é“¾æ¥**" | Add-Content -Path ..\CHANGELOG.md
          "| é•œåƒæº | å¹³å°/æ‰“åŒ…æ–¹å¼ | æ”¯æŒæ¶æ„ | å®Œæ•´ç‰ˆ |" | Add-Content -Path ..\CHANGELOG.md
          "| --- | --- | --- | --- |" | Add-Content -Path ..\CHANGELOG.md
          "| ghfast.top | Windows ç›®å½•æ¨¡å¼ | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://ghfast.top/https://github.com/InkCanvasForClass/community/releases/download/$env:GITHUB_REF_NAME/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "| gh-proxy.com | Windows ç›®å½•æ¨¡å¼ | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://gh-proxy.com/https://github.com/InkCanvasForClass/community/releases/download/$env:GITHUB_REF_NAME/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "| bgithub.xyz | Windows ç›®å½•æ¨¡å¼ | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://bgithub.xyz/InkCanvasForClass/community/releases/download/$env:GITHUB_REF_NAME/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "| kkgithub.com | Windows ç›®å½•æ¨¡å¼ | Any CPU | [ä¸‹è½½ $env:GITHUB_REF_NAME](https://kkgithub.com/InkCanvasForClass/community/releases/download/$env:GITHUB_REF_NAME/InkCanvasForClass.CE.$env:GITHUB_REF_NAME.zip) |" | Add-Content -Path ..\CHANGELOG.md
          "" | Add-Content -Path ..\CHANGELOG.md
          "**SHA256 æ ¡éªŒå€¼-è¯·æ ¸å¯¹ä¸‹è½½çš„æ–‡ä»¶çš„SHA256å€¼æ˜¯å¦æ­£ç¡®**" | Add-Content -Path ..\CHANGELOG.md
          "| æ–‡ä»¶å | SHA256 å€¼ |" | Add-Content -Path ..\CHANGELOG.md
          "| --- | --- |" | Add-Content -Path ..\CHANGELOG.md
          Get-Content SHA256SUMS.txt | ForEach-Object {
            $parts = $_ -split '\s+', 2
            if ($parts.Length -eq 2) {
              "| $($parts[1]) | $($parts[0]) |" | Add-Content -Path ..\CHANGELOG.md
            }
          }
          Remove-Item SHA256SUMS.txt
          Set-Location ..
            
      - name: ç¡®å®šå‘å¸ƒç±»å‹
        id: release-type
        run: |
          if ($env:GITHUB_REF -like "*beta*" -or $env:GITHUB_REF -like "*alpha*") {
            Write-Output "is_beta=true" >> $env:GITHUB_ENV
          } else {
            Write-Output "is_beta=false" >> $env:GITHUB_ENV
          }

      - name: å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: release/*
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ env.is_beta == 'true' }}
          tag_name: ${{ github.ref_name }}
          name: Ink Canvas For Class CE æ–°ç‰ˆæœ¬ - ${{ github.ref_name }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}